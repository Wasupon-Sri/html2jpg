<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crop Me! - Auto Center Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        thai: ['Sarabun', 'sans-serif'],
                    },
                    cursor: { 'grab': 'grab', 'grabbing': 'grabbing' }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(125deg, #ff0080, #7928ca, #41d1ff, #ffea00, #ff0080);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            overflow: hidden; overscroll-behavior: none;
        }
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        .checkerboard { background-color: #e5e5f7; background-image: linear-gradient(45deg, #d4d4e8 25%, transparent 25%), linear-gradient(-45deg, #d4d4e8 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #d4d4e8 75%), linear-gradient(-45deg, transparent 75%, #d4d4e8 75%); background-size: 20px 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Controls */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #FF0080; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(255, 0, 128, 0.5); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(0,0,0,0.1); border-radius: 999px; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }

        #crop-overlay { cursor: crosshair; }
        .crop-selection { border: 2px dashed #fff; background: rgba(255, 255, 255, 0.2); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); position: absolute; pointer-events: none; z-index: 50; }

        /* Default Wrapper Styling: Glass + Dots (Shows when input is clear or transparent) */
        #capture-wrapper {
            background-color: rgba(255, 255, 255, 0.6); 
            background-image: radial-gradient(#94a3b8 1.5px, transparent 1.5px);
            background-size: 24px 24px; 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }

        /* Safe Mode Override */
        #capture-wrapper.safe-mode {
            background: #ffffff !important; 
            backdrop-filter: none !important;
            border: 1px solid #e2e8f0 !important;
        }
        #capture-wrapper.safe-mode * { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative text-gray-800 overflow-hidden">

    <div class="flex-1 relative overflow-hidden flex">
        <div id="canvas-scroller" class="flex-1 h-full w-full overflow-auto checkerboard relative cursor-grab active:cursor-grabbing no-scrollbar">
            <div class="min-w-max min-h-max p-[150vh] flex items-center justify-center">
                <div id="capture-wrapper" class="shadow-2xl relative transition-all duration-300 origin-center group" style="width: 960px; min-height: 600px;">
                    <!-- FIXED: Added flex flex-col items-center justify-center to force centering -->
                    <div id="user-content" class="w-full h-full min-h-[600px] flex flex-col items-center justify-center"></div>
                    <div class="absolute -top-8 left-0 text-xs font-mono font-bold text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 backdrop-blur px-3 py-1 rounded shadow-sm pointer-events-none">
                        <span id="debug-width">960</span>px
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-panel" class="absolute top-6 left-6 z-[40] w-[90vw] max-w-[320px] glass-panel rounded-2xl flex flex-col max-h-[85vh] shadow-2xl transition-shadow duration-300">
            <div id="panel-header" class="p-3 border-b border-white/40 flex justify-between items-center cursor-move select-none bg-white/20 rounded-t-2xl active:bg-white/40 transition-colors">
                <div class="flex items-center gap-2 pointer-events-none">
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center text-white font-bold text-xs shadow-md"><i class="fa-solid fa-crop-simple"></i></div>
                    <h2 class="font-bold text-sm text-slate-800 tracking-tight">Crop Me!</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="centerScroll()" title="Re-Center View" class="w-6 h-6 rounded-full hover:bg-blue-100 text-blue-600 flex items-center justify-center transition-colors cursor-pointer" onmousedown="event.stopPropagation()">
                        <i class="fa-solid fa-crosshairs text-xs"></i>
                    </button>
                    <button onclick="togglePanel()" class="w-6 h-6 rounded-full hover:bg-black/10 flex items-center justify-center transition-colors cursor-pointer" onmousedown="event.stopPropagation()">
                        <i id="panel-chevron" class="fa-solid fa-chevron-down text-xs transition-transform"></i>
                    </button>
                </div>
            </div>

            <div id="panel-content" class="p-4 overflow-y-auto custom-scrollbar space-y-5">
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="text-[10px] font-bold uppercase text-slate-500 tracking-wider">Canvas Width</label>
                        <span id="width-val" class="text-[10px] font-mono font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">960px</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="range" id="width-slider" min="300" max="3000" value="960" class="flex-1">
                        <button onclick="autoFit()" title="Fit to Content" class="w-6 h-6 flex items-center justify-center rounded-md bg-white border border-gray-200 hover:bg-blue-50 text-blue-600 transition-colors shadow-sm"><i class="fa-solid fa-expand text-[10px]"></i></button>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="text-[10px] font-bold uppercase text-slate-500 tracking-wider">Zoom / Scale</label>
                        <div id="quality-badge" class="text-[9px] font-bold bg-gradient-to-r from-purple-500 to-pink-500 text-white px-1.5 py-0.5 rounded-full shadow-sm">4K ULTRA</div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="range" id="zoom-slider" min="1" max="10" step="0.1" value="4" class="flex-1">
                        <span id="zoom-val" class="text-[10px] font-mono font-bold w-8 text-right">4.0x</span>
                    </div>
                    <div class="text-[9px] text-center text-slate-400 font-mono">Output: <span id="calc-res">3840 x Auto</span> px</div>
                </div>

                <div class="space-y-2">
                    <div class="flex items-center justify-between bg-indigo-50 p-2.5 rounded-lg border border-indigo-100">
                        <div class="flex flex-col"><span class="text-xs font-bold text-indigo-900">âœ¨ Safe Mode</span><span class="text-[9px] text-indigo-600 font-medium">Remove Glass/Dots</span></div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="safe-mode-toggle" class="sr-only peer" onchange="toggleSafeMode()">
                            <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <label class="text-[10px] font-bold uppercase text-slate-500 tracking-wider">HTML</label>
                            <span id="fix-indicator" class="hidden text-amber-600 bg-amber-100 px-1.5 py-0.5 rounded text-[9px] font-bold animate-pulse">Issues</span>
                        </div>
                        <div class="flex gap-1">
                            <button id="auto-fix-btn" onclick="autoFixHTML()" class="text-[9px] bg-gradient-to-r from-amber-200 to-yellow-400 text-amber-900 hover:from-amber-300 hover:to-yellow-500 px-2 py-1 rounded transition font-bold shadow-sm" title="Auto-Fix Layout"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto Fix</button>
                            <button onclick="pasteCode()" class="text-[9px] bg-indigo-100 text-indigo-600 hover:bg-indigo-200 px-2 py-1 rounded transition font-bold" title="Paste"><i class="fa-solid fa-paste"></i></button>
                            <button onclick="clearCode()" class="text-[9px] bg-red-100 text-red-600 hover:bg-red-200 px-2 py-1 rounded transition">Clear</button>
                        </div>
                    </div>
                    <textarea id="code-input" class="w-full h-28 p-2 font-mono text-[10px] bg-slate-900 text-green-400 rounded-xl resize-y focus:outline-none focus:ring-2 focus:ring-pink-500 shadow-inner leading-relaxed custom-scrollbar" spellcheck="false" placeholder="<h1>Paste HTML here...</h1>"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-2 pt-1">
                    <label class="cursor-pointer flex items-center justify-center gap-2 bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 py-2 rounded-lg text-xs font-bold transition-all shadow-sm active:scale-95"><i class="fa-solid fa-upload"></i> Upload<input type="file" id="file-upload" accept=".html,.txt" class="hidden"></label>
                    <button onclick="openNewTab()" class="flex items-center justify-center gap-2 bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 py-2 rounded-lg text-xs font-bold transition-all shadow-sm active:scale-95"><i class="fa-solid fa-arrow-up-right-from-square"></i> Preview</button>
                </div>

                <div class="pt-2 border-t border-white/40">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="startCropMode()" class="group relative overflow-hidden flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg text-xs font-bold transition-all shadow-lg shadow-indigo-500/30 active:scale-95"><span class="relative z-10 flex items-center gap-2"><i class="fa-solid fa-crop-simple"></i> Crop</span></button>
                        <button onclick="capture(false)" class="group relative overflow-hidden flex items-center justify-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white py-2.5 rounded-lg text-xs font-bold transition-all shadow-lg shadow-pink-500/30 active:scale-95"><span class="relative z-10 flex items-center gap-2"><i class="fa-solid fa-camera"></i> Capture</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="crop-toolbar" class="fixed top-6 left-1/2 -translate-x-1/2 bg-white rounded-full shadow-2xl px-6 py-3 flex gap-4 items-center z-[70] animate-bounce-in hidden">
        <span class="text-sm font-bold text-gray-600 mr-2"><i class="fa-solid fa-scissors mr-1"></i> Draw box to snap</span>
        <button onclick="cancelCrop()" class="text-sm font-bold text-gray-500 hover:text-gray-800 transition">Cancel</button>
        <div class="h-4 w-[1px] bg-gray-300"></div>
        <button onclick="snapCrop()" class="text-sm font-bold text-white bg-black hover:bg-gray-800 px-4 py-1.5 rounded-full shadow-md transition transform active:scale-95">Snap!</button>
    </div>
    <div id="crop-overlay" class="fixed inset-0 z-50 hidden select-none touch-none bg-black/30"><div id="crop-box" class="crop-selection hidden"></div></div>
    <div id="loader" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center hidden">
        <div class="relative w-24 h-24 mb-8"><div class="absolute inset-0 border-t-4 border-pink-500 rounded-full animate-spin"></div><div class="absolute inset-2 border-t-4 border-cyan-400 rounded-full animate-spin" style="animation-duration: 1.5s; animation-direction: reverse;"></div><div class="absolute inset-4 border-t-4 border-yellow-400 rounded-full animate-spin" style="animation-duration: 2s;"></div></div>
        <h3 class="text-white text-3xl font-bold tracking-widest animate-pulse">RENDERING</h3>
        <p id="loader-status" class="text-gray-400 font-mono text-sm mt-2">Generating High-Res Pixels...</p>
    </div>

    <button onclick="centerScroll()" class="fixed bottom-6 right-6 z-40 bg-white text-slate-700 p-3 rounded-full shadow-lg hover:bg-slate-50 transition-all active:scale-95" title="Re-Center View">
        <i class="fa-solid fa-crosshairs"></i>
    </button>

    <script>
        const codeInput=document.getElementById('code-input'),userContent=document.getElementById('user-content'),captureWrapper=document.getElementById('capture-wrapper'),canvasScroller=document.getElementById('canvas-scroller'),widthSlider=document.getElementById('width-slider'),widthVal=document.getElementById('width-val'),debugWidth=document.getElementById('debug-width'),zoomSlider=document.getElementById('zoom-slider'),zoomVal=document.getElementById('zoom-val'),calcRes=document.getElementById('calc-res'),loader=document.getElementById('loader'),panel=document.getElementById('settings-panel'),panelHeader=document.getElementById('panel-header'),panelContent=document.getElementById('panel-content'),panelChevron=document.getElementById('panel-chevron'),qualityBadge=document.getElementById('quality-badge'),cropOverlay=document.getElementById('crop-overlay'),cropBox=document.getElementById('crop-box'),cropToolbar=document.getElementById('crop-toolbar'),fixIndicator=document.getElementById('fix-indicator'),fixBtn=document.getElementById('auto-fix-btn');
        let isPanelOpen=!0,isCropping=!1,isPanning=!1,startX,startY;

        const defaultHTML=`<div class="w-full h-full min-h-[600px] flex items-center justify-center p-12"><div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div><div class="relative px-7 py-6 bg-white ring-1 ring-gray-900/5 rounded-2xl leading-none flex items-top justify-start space-x-6"><div class="space-y-2"><div class="flex items-center gap-3"><span class="text-3xl">ðŸš€</span><p class="text-slate-800 text-2xl font-bold font-sans">Crop Me!</p></div><p class="text-slate-600 max-w-sm text-base leading-relaxed">Glass background is ON. Content sits <span class="font-bold text-pink-600">on top</span>.</p></div></div></div></div>`;

        // FORCE CENTERING SEQUENCE (Runs 3 times to guarantee catch)
        window.addEventListener('DOMContentLoaded', () => {
            loadSample();
            updateCalculations();
            // 1. Immediate
            centerScroll();
            // 2. Next Frame (Browser render)
            requestAnimationFrame(centerScroll);
            // 3. Delayed (Wait for layout settlement)
            setTimeout(centerScroll, 500);
        });

        // --- FIXED CENTERING LOGIC ---
        function centerScroll(){
            const scroller = document.getElementById("canvas-scroller");
            scroller.scrollLeft = (scroller.scrollWidth - scroller.clientWidth) / 2;
            scroller.scrollTop = (scroller.scrollHeight - scroller.clientHeight) / 2;
        }

        // --- PANNING LOGIC ---
        let panStartX,panStartY,panScrollLeft,panScrollTop;
        canvasScroller.addEventListener('mousedown',(e)=>{if(isCropping||e.target.closest('input')||e.target.closest('button'))return;isPanning=!0;canvasScroller.classList.add('cursor-grabbing');canvasScroller.classList.remove('cursor-grab');panStartX=e.pageX-canvasScroller.offsetLeft;panStartY=e.pageY-canvasScroller.offsetTop;panScrollLeft=canvasScroller.scrollLeft;panScrollTop=canvasScroller.scrollTop;});
        canvasScroller.addEventListener('mouseleave',()=>{isPanning=!1;canvasScroller.classList.remove('cursor-grabbing');canvasScroller.classList.add('cursor-grab');});
        canvasScroller.addEventListener('mouseup',()=>{isPanning=!1;canvasScroller.classList.remove('cursor-grabbing');canvasScroller.classList.add('cursor-grab');});
        canvasScroller.addEventListener('mousemove',(e)=>{if(!isPanning)return;e.preventDefault();const t=e.pageX-canvasScroller.offsetLeft,n=e.pageY-canvasScroller.offsetTop,o=1.5*(t-panStartX),r=1.5*(n-panStartY);canvasScroller.scrollLeft=panScrollLeft-o;canvasScroller.scrollTop=panScrollTop-r;});

        // --- PANEL DRAG ---
        let isDragging=!1,initialX,initialY,xOffset=0,yOffset=0;
        panelHeader.addEventListener("mousedown",dragStart);document.addEventListener("mousemove",drag);document.addEventListener("mouseup",dragEnd);
        panelHeader.addEventListener("touchstart",dragStart,{passive:!1});document.addEventListener("touchmove",drag,{passive:!1});document.addEventListener("touchend",dragEnd);
        function dragStart(e){if(e.target.closest('button'))return;"touchstart"===e.type?(initialX=e.touches[0].clientX-xOffset,initialY=e.touches[0].clientY-yOffset):(initialX=e.clientX-xOffset,initialY=e.clientY-yOffset);(e.target===panelHeader||panelHeader.contains(e.target))&&(isDragging=!0,panel.classList.add("shadow-2xl","scale-[1.01]"))}
        function drag(e){if(isDragging){e.preventDefault();let t,n;"touchmove"===e.type?(t=e.touches[0].clientX-initialX,n=e.touches[0].clientY-initialY):(t=e.clientX-initialX,n=e.clientY-initialY);xOffset=t,yOffset=n,setTranslate(t,n,panel)}}
        function setTranslate(e,t,n){n.style.transform="translate3d("+e+"px, "+t+"px, 0)"}
        function dragEnd(e){initialX=xOffset,initialY=yOffset,isDragging=!1,panel.classList.remove("shadow-2xl","scale-[1.01]")}

        // --- MAIN FUNCTIONS ---
        function loadSample(){codeInput.value=defaultHTML;updatePreview();checkCodeHealth()}
        function clearCode(){codeInput.value='';updatePreview();checkCodeHealth()}
        async function pasteCode(){try{const e=await navigator.clipboard.readText();codeInput.value=e;updatePreview();checkCodeHealth();setTimeout(centerScroll, 100);}catch(e){alert('Browser blocked automatic paste.')}}
        function updatePreview(){userContent.innerHTML=codeInput.value}
        function checkCodeHealth(){const e=codeInput.value;if(!e)return void fixIndicator.classList.add('hidden');let t=!1;e.includes('<body')&&!e.includes('min-w-[')&&(t=!0),!e.includes('<body')&&!e.includes('min-w-[')&&(t=!0),e.includes('w-fit')&&(t=!0),e.includes('<h1')&&!e.includes('whitespace-nowrap')&&(t=!0);t?(fixIndicator.classList.remove('hidden'),fixBtn.classList.add('animate-pulse','ring-2','ring-amber-400')):(fixIndicator.classList.add('hidden'),fixBtn.classList.remove('animate-pulse','ring-2','ring-amber-400'))}

        function autoFixHTML(){let e=codeInput.value;if(!e)return;e.includes('<body')?e.includes('min-w-[')||(e=e.includes('class="')?e.replace(/class="([^"]*)"/i,'class="$1 min-w-[1000px]"'):e.replace(/<body/i,'<body class="min-w-[1000px]"')):e.includes('min-w-[1000px]')||(e=`<div class="min-w-[1000px] w-full h-full flex flex-col items-center justify-center">${e}</div>`);e.includes('<h1')&&(e.includes('whitespace-nowrap')||(e=e.replace(/<h1(.*?)class="/gi,'<h1$1class="whitespace-nowrap '),e=e.replace(/<h1(?![^>]*class=)([^>]*)>/gi,'<h1$1 class="whitespace-nowrap">')));e=e.replace(/w-fit/g,'min-w-max'),e=e.replace(/inline-block/g,'block');codeInput.value=e;updatePreview();checkCodeHealth();const t=fixBtn.innerHTML;fixBtn.innerHTML='<i class="fa-solid fa-check"></i> Fixed!',fixBtn.classList.remove('animate-pulse','ring-2','ring-amber-400'),setTimeout(()=>{fixBtn.innerHTML=t},2e3)}

        function toggleSafeMode(){document.getElementById('safe-mode-toggle').checked?captureWrapper.classList.add('safe-mode'):captureWrapper.classList.remove('safe-mode')}
        codeInput.addEventListener('input',()=>{updatePreview();checkCodeHealth()});
        function togglePanel(){isPanelOpen=!isPanelOpen;isPanelOpen?(panelContent.style.display='block',panelChevron.style.transform='rotate(0deg)'):(panelContent.style.display='none',panelChevron.style.transform='rotate(-90deg)')}
        widthSlider.addEventListener('input',e=>{const t=e.target.value+'px';captureWrapper.style.width=t;widthVal.textContent=t;debugWidth.textContent=e.target.value;updateCalculations()});
        zoomSlider.addEventListener('input',e=>{zoomVal.textContent=e.target.value+'x';updateCalculations()});
        function autoFit(){captureWrapper.style.width='min-content';const e=userContent.scrollWidth,t=Math.max(300,e);captureWrapper.style.width=t+'px';widthSlider.value=t;widthVal.textContent=t+'px';debugWidth.textContent=t;updateCalculations()}
        document.getElementById('file-upload').addEventListener('change',function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){codeInput.value=e.target.result;updatePreview();checkCodeHealth();setTimeout(centerScroll, 100);};n.readAsText(t)});
        function openNewTab(){const e=window.open('','_blank'),t=`<!DOCTYPE html><html><head><title>Crop Me! Preview</title><script src="https://cdn.tailwindcss.com"><\/script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet"><style>body { font-family: 'Outfit', sans-serif; margin: 0; }</style></head><body>${codeInput.value}</body></html>`;e.document.write(t),e.document.close()}
        function updateCalculations(){const e=parseInt(widthSlider.value),t=parseFloat(zoomSlider.value),n=Math.round(e*t);calcRes.textContent=`${n} x Auto`;qualityBadge.className="text-[10px] font-bold text-white px-2 py-0.5 rounded-full shadow-sm transition-colors";n<1920?(qualityBadge.textContent="SD",qualityBadge.classList.add("bg-gray-500")):n<3840?(qualityBadge.textContent="HD",qualityBadge.classList.add("bg-green-500")):n<7680?(qualityBadge.textContent="4K ULTRA",qualityBadge.classList.add("bg-gradient-to-r","from-purple-500","to-pink-500")):(qualityBadge.textContent="8K INSANE",qualityBadge.classList.add("bg-gradient-to-r","from-yellow-500","to-red-600"))}

        // --- FIXED CAPTURE: scrollWidth to get full text ---
        async function capture(e=!1,t=null){loader.classList.remove('hidden');document.getElementById('loader-status').textContent=e?"Cropping High-Res Region...":"Rendering Full Canvas...";await document.fonts.ready;let n=0,o=0,r=0,a=0;if(e&&t){const e=captureWrapper.getBoundingClientRect();n=t.x-e.left,o=t.y-e.top,r=t.width,a=t.height}const c=parseFloat(zoomSlider.value),i=captureWrapper.offsetWidth,l=captureWrapper.offsetHeight,d={backgroundColor:null,pixelRatio:c,width:captureWrapper.scrollWidth,height:captureWrapper.scrollHeight,style:{transform:'none',margin:'0',left:'0',top:'0'}};try{const i=await htmlToImage.toJpeg(captureWrapper,d);let l=i;if(e&&t){const e=new Image;e.src=i,await new Promise(t=>e.onload=t);const d=document.createElement("canvas");d.width=r*c,d.height=a*c;d.getContext("2d").drawImage(e,n*c,o*c,r*c,a*c,0,0,d.width,d.height),l=d.toDataURL("image/jpeg",.95)}const u=document.createElement("a");u.download=`cropme-${Date.now()}.jpg`,u.href=l,u.click()}catch(e){console.error(e),alert("Error capturing image. Check console for details.")}finally{loader.classList.add('hidden'),e&&endCropMode()}}

        // Crop Selection
        function startCropMode(){isCropping=!0;isPanelOpen=!1;togglePanel();cropOverlay.classList.remove('hidden');cropBox.classList.add('hidden');cropToolbar.classList.remove('hidden');cropToolbar.classList.add('flex');cropBox.style.width='0';cropBox.style.height='0'}
        function endCropMode(){isCropping=!1;cropOverlay.classList.add('hidden');cropToolbar.classList.add('hidden');cropToolbar.classList.remove('flex');isPanelOpen=!0;panelContent.style.display='block';panelChevron.style.transform='rotate(0deg)'}
        function cancelCrop(){endCropMode()}
        function getPointerPos(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}
        cropOverlay.addEventListener('mousedown',cropStart);cropOverlay.addEventListener('touchstart',cropStart,{passive:!1});
        function cropStart(e){if(e.target.closest('#crop-toolbar'))return;e.preventDefault();const t=getPointerPos(e);startX=t.x;startY=t.y;cropBox.classList.remove('hidden');cropBox.style.left=startX+'px';cropBox.style.top=startY+'px';cropBox.style.width='0px';cropBox.style.height='0px';document.addEventListener('mousemove',cropMove);document.addEventListener('touchmove',cropMove,{passive:!1});document.addEventListener('mouseup',cropEnd);document.addEventListener('touchend',cropEnd)}
        function cropMove(e){e.preventDefault();const t=getPointerPos(e);let n=t.x-startX,o=t.y-startY,r=startX,a=startY;n<0&&(r=t.x,n=Math.abs(n)),o<0&&(a=t.y,o=Math.abs(o));cropBox.style.left=r+'px';cropBox.style.top=a+'px';cropBox.style.width=n+'px';cropBox.style.height=o+'px'}
        function cropEnd(e){document.removeEventListener('mousemove',cropMove);document.removeEventListener('touchmove',cropMove);document.removeEventListener('mouseup',cropEnd);document.removeEventListener('touchend',cropEnd)}
        function snapCrop(){const e={x:parseInt(cropBox.style.left),y:parseInt(cropBox.style.top),width:parseInt(cropBox.style.width),height:parseInt(cropBox.style.height)};if(e.width<10||e.height<10)return void alert("Selection too small!");capture(!0,e)}
    </script>
</body>
</html>
